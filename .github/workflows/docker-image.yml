name: Docker Image CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        include:
          - name: model-service
            context: ./digicloset-upgrade-pack
            dockerfile: ./digicloset-upgrade-pack/model-service/Dockerfile
          - name: model-service-complete
            context: ./digicloset-upgrade-pack-complete
            dockerfile: ./digicloset-upgrade-pack-complete/model-service/Dockerfile

    steps:
      - uses: actions/checkout@v4

      - name: Validate build inputs (${{ matrix.name }})
        shell: bash
        run: |
          set -euo pipefail
          test -d "${{ matrix.context }}"
          test -f "${{ matrix.dockerfile }}"

      - name: Build Docker image (${{ matrix.name }}) with retry
        shell: bash
        run: |
          set -euo pipefail
          for attempt in 1 2 3; do
            if docker build \
              "${{ matrix.context }}" \
              --file "${{ matrix.dockerfile }}" \
              --tag "${{ matrix.name }}:${{ github.sha }}"; then
              exit 0
            fi

            if [ "$attempt" -lt 3 ]; then
              echo "Retrying docker build for ${{ matrix.name }} (attempt $attempt failed)"
              sleep 10
            fi
          done

          echo "Docker build failed after 3 attempts for ${{ matrix.name }}"
          exit 1
